# Coverage Report Sanitization

## Overview

This document explains the coverage report sanitization process implemented to prevent PII (Personally Identifiable Information) leakage in coverage reports.

## Problem

Go coverage reports generated by `go test -cover` and `go tool cover` can contain sensitive information such as:

- Absolute file paths that include usernames (e.g., `/Users/username/...`)
- Home directory paths (e.g., `/home/username/...`)
- Windows user paths (e.g., `C:\Users\username\...`)
- Email addresses that might be embedded in comments or strings
- Machine-specific timestamps and metadata

When these reports are committed to version control or shared publicly, they can leak personal information about developers.

## Solution

### 1. Gitignore Configuration

Coverage files are excluded from version control by adding them to `.gitignore`:

```gitignore
# Coverage reports - may contain sensitive information
coverage.html
combined-cover.out
cover.out
*.cover.out
*.coverprofile.out
```

### 2. Sanitization Script

A sanitization script (`hack/sanitize-coverage.sh`) has been implemented that:

- Removes absolute paths and replaces them with redacted placeholders
- Replaces email-like patterns with `REDACTED_EMAIL`
- Removes machine-specific timestamps
- Handles both Unix and Windows path formats
- Processes both HTML and text coverage reports

### 3. Makefile Integration

The Makefile provides separate targets for coverage report generation and sanitization:

- `make coverage-report`: Combines and generates coverage reports (without sanitization)
- `make coverage-report-sanitized`: Runs sanitization on existing coverage reports for CI use

## Usage

### For Local Development

```bash
# Generate coverage reports (without sanitization)
make coverage-report

# Generate sanitized reports for CI (requires coverage-report first)
make coverage-report-sanitized
```

### Manual Sanitization

```bash
# Run the sanitization script manually
./hack/sanitize-coverage.sh
```

### For CI/CD

In CI pipelines, use the sanitized coverage reports:

```bash
# Generate coverage reports first, then sanitize for CI
make coverage-report
make coverage-report-sanitized

# Upload sanitized reports to coverage services
# Example: Codecov Uploader (recommended)
curl -sSLf https://uploader.codecov.io/latest/linux/codecov -o codecov
chmod +x codecov
curl -sSLf https://uploader.codecov.io/latest/linux/codecov.SHA256SUM -o codecov.SHA256SUM
sha256sum --ignore-missing -c codecov.SHA256SUM
./codecov -f combined-cover-sanitized.out

## Sanitized Files

The sanitization process creates the following files:

- `coverage-sanitized.html`: Sanitized HTML coverage report
- `combined-cover-sanitized.out`: Sanitized combined coverage data
- `cover-sanitized.out`: Sanitized individual coverage data
- `sanitized-*.cover.out`: Sanitized individual coverage files

## What Gets Sanitized

The sanitization script removes or replaces:

1. **User/Home Path Prefixes** (only the prefix, preserving repo-relative paths):
   - `/Users/username/` → `/Users/REDACTED/`
   - `/home/username/` → `/home/REDACTED/`
   - `C:\Users\username\` → `C:\Users\REDACTED\`
   
   **Important**: Only the user/home prefix is replaced. The rest of the path (including repo root, directories, and filenames) must remain untouched so coverage tooling can correctly map files.

2. **Email Addresses**:
   - `user@example.com` → `REDACTED_EMAIL`

3. **Timestamps**:
   - `2023-08-21T10:30:00Z` → `REDACTED_TIMESTAMP`

4. **Build and Temporary Paths**:
   - `/tmp/` → `/REDACTED_TMP/`
   - Non-repo build roots only (outside the repo root):
     - `/var/build/...` → `/REDACTED_BUILD/...`
     - `/var/tmp/dist/...` → `/REDACTED_DIST/...`
     - `/work/target/...` → `/REDACTED_TARGET/...`

**Note**: The sanitization script also redacts paths under `/tmp` and common build directories (e.g., `build/`, `dist/`, `target/`) to remove system-specific and build artifact paths. These redactions are intentional and do not break coverage mapping since they typically contain generated or temporary files that are not part of the source code being measured. In-repo directories named `build/`, `dist/`, or `target/` must NOT be redacted. Only redact absolute paths outside the repo root to preserve coverage mapping.

**Important Guidelines**:
- **Strip only the prefix**: Replace only the user/home directory prefix (e.g., `/Users/username/` → `/Users/REDACTED/`)
- **Preserve repo structure**: Leave everything after the repo root completely untouched
- **Maintain file paths**: Do not replace the trailing filename or module-relative path
- **Keep coverage mapping intact**: Ensure coverage tooling can still correctly map files to their source locations

**Example of correct sanitization**:
- Before: `/Users/johndoe/projects/opendatahub-operator/internal/controller/components.go`
- After: `/Users/REDACTED/projects/opendatahub-operator/internal/controller/components.go`

**Example of incorrect sanitization** (over-redaction):
- Before: `/Users/johndoe/projects/opendatahub-operator/internal/controller/components.go`
- After: `/REDACTED_PATH/components.go` ❌ (breaks coverage mapping)

## Security Considerations

- **Original files**: Never commit original coverage files to version control
- **Sanitized files**: Safe to commit and share publicly
- **CI artifacts**: Use sanitized reports for public coverage services
- **Local development**: Original files are useful for debugging but should be kept local

## Troubleshooting

### Script Not Working

1. Ensure the script is executable: `chmod +x hack/sanitize-coverage.sh`
2. Check that you have the required tools: `sed`, `grep`, `find`
3. Verify the script has proper permissions

### Still Seeing Sensitive Information

1. Check if new path patterns need to be added to the sanitization script
2. Verify that the sanitized files are being used, not the original ones
3. Run the script manually to see detailed output

### Coverage Reports Not Generated

1. Ensure tests are passing: `make test`
2. Check that coverage flags are enabled in test commands
3. Verify that the Go toolchain is properly installed

## Contributing

When adding new coverage-related functionality:

1. Update the sanitization script if new patterns are identified
2. Add new coverage file patterns to `.gitignore`
3. Update this documentation with any changes
4. Test the sanitization process with your changes

## References

- [Go Coverage Documentation](https://golang.org/cmd/cover/)
- [Go Test Coverage](https://blog.golang.org/cover)
- [OWASP Top 10 — 2021 (Cryptographic Failures)](https://owasp.org/Top10/A02_2021-Cryptographic_Failures/)
