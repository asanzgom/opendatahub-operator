# Coverage Report Sanitization

## Overview

This document explains the coverage report sanitization process implemented to prevent PII (Personally Identifiable Information) leakage in coverage reports.

## Problem

Go coverage reports generated by `go test -cover` and `go tool cover` can contain sensitive information such as:

- Absolute file paths that include usernames (e.g., `/Users/username/...`)
- Home directory paths (e.g., `/home/username/...`)
- Windows user paths (e.g., `C:\Users\username\...`)
- Email addresses that might be embedded in comments or strings
- Machine-specific timestamps and metadata

When these reports are committed to version control or shared publicly, they can leak personal information about developers.

## Solution

### 1. Gitignore Configuration

Coverage files are excluded from version control by adding them to `.gitignore`:

```
# Coverage reports - may contain sensitive information
coverage.html
combined-cover.out
cover.out
*.cover.out
*.coverprofile.out
```

### 2. Sanitization Script

A sanitization script (`hack/sanitize-coverage.sh`) has been implemented that:

- Removes absolute paths and replaces them with redacted placeholders
- Replaces email-like patterns with `REDACTED_EMAIL`
- Removes machine-specific timestamps
- Handles both Unix and Windows path formats
- Processes both HTML and text coverage reports

### 3. Makefile Integration

The Makefile has been updated to automatically sanitize coverage reports:

- `make coverage-report`: Generates coverage reports and sanitizes them
- `make coverage-report-sanitized`: Generates sanitized coverage reports for CI

## Usage

### For Local Development

```bash
# Generate coverage reports (automatically sanitized)
make coverage-report

# Or generate only sanitized reports
make coverage-report-sanitized
```

### Manual Sanitization

```bash
# Run the sanitization script manually
./hack/sanitize-coverage.sh
```

### For CI/CD

In CI pipelines, use the sanitized coverage reports:

```bash
# Generate sanitized reports
make coverage-report-sanitized

# Upload sanitized reports to coverage services
# Example: codecov.io
curl -s https://codecov.io/bash | bash -s -- -f combined-cover-sanitized.out
```

## Sanitized Files

The sanitization process creates the following files:

- `coverage-sanitized.html`: Sanitized HTML coverage report
- `combined-cover-sanitized.out`: Sanitized combined coverage data
- `cover-sanitized.out`: Sanitized individual coverage data
- `sanitized-*.cover.out`: Sanitized individual coverage files

## What Gets Sanitized

The sanitization script removes or replaces:

1. **Absolute Paths**:
   - `/Users/username/` → `/Users/REDACTED/`
   - `/home/username/` → `/home/REDACTED/`
   - `C:\Users\username\` → `C:\Users\REDACTED\`

2. **Email Addresses**:
   - `user@example.com` → `REDACTED_EMAIL`

3. **Timestamps**:
   - `2023-08-21T10:30:00Z` → `REDACTED_TIMESTAMP`

4. **Machine-Specific Paths**:
   - Any path containing potential usernames → `/REDACTED_PATH`

## Security Considerations

- **Original files**: Never commit original coverage files to version control
- **Sanitized files**: Safe to commit and share publicly
- **CI artifacts**: Use sanitized reports for public coverage services
- **Local development**: Original files are useful for debugging but should be kept local

## Troubleshooting

### Script Not Working

1. Ensure the script is executable: `chmod +x hack/sanitize-coverage.sh`
2. Check that you have the required tools: `sed`, `grep`, `find`
3. Verify the script has proper permissions

### Still Seeing Sensitive Information

1. Check if new path patterns need to be added to the sanitization script
2. Verify that the sanitized files are being used, not the original ones
3. Run the script manually to see detailed output

### Coverage Reports Not Generated

1. Ensure tests are passing: `make test`
2. Check that coverage flags are enabled in test commands
3. Verify that the Go toolchain is properly installed

## Contributing

When adding new coverage-related functionality:

1. Update the sanitization script if new patterns are identified
2. Add new coverage file patterns to `.gitignore`
3. Update this documentation with any changes
4. Test the sanitization process with your changes

## References

- [Go Coverage Documentation](https://golang.org/cmd/cover/)
- [Go Test Coverage](https://blog.golang.org/cover)
- [PII Protection Best Practices](https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure)
